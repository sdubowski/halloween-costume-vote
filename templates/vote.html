{% extends "base.html" %}
{% block content %}

<style>
  /* body przewija â€“ brak fixed scrollera */
  html, body {
    min-height: 100%;
    overflow: auto;
    overscroll-behavior: none;
  }

  /* mobilny snap (bez overflow na kontenerze) */
  .vote-snap-container {
    margin-top: 56px;
    min-height: calc(100svh - 56px);
    scroll-snap-type: y mandatory;
    overscroll-behavior-y: contain;
    touch-action: pan-y;
  }
  .vote-snap-item {
    min-height: calc(100svh - 56px);
    scroll-snap-align: start;
  }

  .vote-card {
    background: #151522;
    border: 1px solid #28283a;
    border-radius: .8rem;
    padding: 12px;
    margin: 0 8px;
    width: 100%;
    max-width: 560px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }

  .vote-photo {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .vote-photo img {
    width: 100%;
    height: auto;
    max-height: 72vh;
    object-fit: contain;
    border-radius: .6rem;
    background: #0b0b12;
    display: block;
  }

  .vote-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-top: 12px;
  }

  .vote-name {
    font-size: 1.25rem;
    font-weight: 600;
  }

  @media (min-width: 992px) {
    .vote-snap-container { margin-top: 0; min-height: auto; scroll-snap-type: none; }
    .vote-snap-item { min-height: auto; }
    .vote-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }
  }

  .btn-primary {
    background-color: #ff6600;
    border-color: #ff6600;
    color: #fff;
  }
  .btn-primary:hover {
    background-color: #ff7e1a;
    border-color: #ff7e1a;
  }
</style>

<h1 class="h4 mb-3 text-center text-warning">GÅ‚osowanie ðŸŽƒ</h1>

{% if candidates %}
  <!-- MOBILE (scroll-snap; przewija body) -->
  <div class="vote-snap-container d-lg-none">
    <form method="post">
      {% for c in candidates %}
      <section class="vote-snap-item">
        <div class="vote-card mx-auto">
          <div class="vote-photo">
            {% if c.photo_path %}
              <img
                data-src="{{ url_for('serve_uploads', fname=c.photo_path) }}?u={{ c.id }}&e={{ event.id }}"
                alt="{{ c.name }}"
                width="800" height="1000"
                loading="eager"
              >
            {% else %}
              <div class="text-muted">Brak zdjÄ™cia</div>
            {% endif %}
          </div>
          <div class="vote-footer">
            <div class="vote-name">{{ c.name }}</div>
            <button name="candidate_id" value="{{ c.id }}" class="btn btn-primary w-50"
                    {% if has_voted %}disabled{% endif %}>
              ZagÅ‚osuj
            </button>
          </div>
        </div>
      </section>
      {% endfor %}
    </form>
  </div>

  <!-- DESKTOP (siatka) -->
  <form method="post" class="d-none d-lg-block">
    <div class="vote-grid">
      {% for c in candidates %}
      <div class="vote-card">
        <div class="vote-photo">
          {% if c.photo_path %}
            <img
              src="{{ url_for('serve_uploads', fname=c.photo_path) }}"
              alt="{{ c.name }}"
              width="800" height="1000"
              loading="lazy"
            >
          {% else %}
            <div class="text-muted">Brak zdjÄ™cia</div>
          {% endif %}
        </div>
        <div class="vote-footer">
          <div class="vote-name">{{ c.name }}</div>
          <button name="candidate_id" value="{{ c.id }}" class="btn btn-outline-light"
                  {% if has_voted %}disabled{% endif %}>
            ZagÅ‚osuj
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
  </form>

{% else %}
  <div class="alert alert-warning text-center mt-4">
    Brak innych zarejestrowanych uczestnikÃ³w na razie.
  </div>
{% endif %}

<script>
(function(){
  // ===== 1) DÅºwiÄ™k po interakcji (priming) =====
  function primeAudio() {
    try { localStorage.setItem('allowWinnerSound', '1'); } catch (e) {}
    try {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return;
      (window.__ac ||= new AC()).resume && window.__ac.resume();
    } catch (e) {}
  }
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[name="candidate_id"]');
    if (btn) primeAudio();
  }, { capture: true });

  // ===== 2) Auto-przejÅ›cie do wynikÃ³w =====
  (function autoToResults(){
    const url = "{{ url_for('wait_status', event_id=event.id) }}";
    async function tick(){
      try{
        const r = await fetch(url, { cache: 'no-store' });
        const d = await r.json();
        if (d.votes >= d.joined && d.joined > 0) {
          location.href = "{{ url_for('results', event_id=event.id) }}";
          return;
        }
      }catch(e){}
      setTimeout(tick, 2000);
    }
    tick();
  })();

  // ===== 3) Prosty workaround dla iOS 17 + leniwe Å‚adowanie =====
  (function iosAndLazyLoad(){
    const ua = navigator.userAgent || "";
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const m = ua.match(/OS (\d+)_/);
    const isIOS17 = isIOS && m && parseInt(m[1], 10) < 18;

    const imgs = Array.from(document.querySelectorAll('.vote-photo img'));

    function forceJpeg(u) {
      try {
        const url = new URL(u, location.href);
        if (!url.searchParams.get('fmt')) url.searchParams.set('fmt', 'jpg');
        return url.toString();
      } catch { return u; }
    }

    // Przygotowanie ÅºrÃ³deÅ‚ dla iOS 17 (wytnij srcset i wymuÅ› JPG)
    if (isIOS17) {
      imgs.forEach(img => {
        img.removeAttribute('srcset');
        const raw = img.getAttribute('data-src') || img.getAttribute('src');
        if (raw) {
          const fixed = forceJpeg(raw);
          if (img.hasAttribute('data-src')) img.setAttribute('data-src', fixed);
          if (img.hasAttribute('src'))      img.setAttribute('src', fixed);
        }
      });
    }

    // Leniwe wczytywanie obrazÃ³w, jeÅ›li majÄ… data-src
    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (!entry.isIntersecting) return;
          const img = entry.target;
          const desired = img.getAttribute('data-src');
          if (desired && img.src !== desired) img.src = desired;
          io.unobserve(img);
        });
      }, { root: null, rootMargin: '200px', threshold: 0.01 });

      imgs.forEach(img => {
        if (img.getAttribute('data-src')) io.observe(img);
      });
    } else {
      // Fallback bez IO
      imgs.forEach(img => {
        const desired = img.getAttribute('data-src');
        if (desired) img.src = desired;
      });
    }

    // Awaryjne dociÄ…gniÄ™cie przez fetch->blob tylko gdy obraz nie startuje
    async function blobKick(img, url) {
      try {
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const b = await r.blob();
        img.src = URL.createObjectURL(b);
      } catch {
        img.src = 'data:image/svg+xml;utf8,' +
          encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="1000"><rect width="100%" height="100%" fill="#0b0b12"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#ff6600" font-size="28">Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ zdjÄ™cia</text></svg>');
      }
    }

    imgs.forEach(img => {
      img.addEventListener('error', () => {
        const u = img.getAttribute('data-src') || img.src;
        if (isIOS17 && u) blobKick(img, u);
      }, { once: true });

      // jeÅ›li po chwili dalej brak rozmiaru, sprÃ³buj blobKick
      setTimeout(() => {
        if (isIOS17 && (!img.complete || img.naturalWidth === 0)) {
          const u = img.getAttribute('data-src') || img.src;
          if (u) blobKick(img, u);
        }
      }, 800);
    });
  })();
})();
</script>

{% endblock %}
